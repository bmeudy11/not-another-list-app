name: React SAST (Security-Focused Static Code Analysis)

on:
  push:
    branches: [ main ]
    paths:
      - 'natl-frontend/**'
      - '.github/workflows/react-sast.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'natl-frontend/**'
      - '.github/workflows/react-sast.yml'
  schedule:
    # Run weekly on Mondays at 3 AM UTC
    - cron: '0 3 * * 1'

jobs:
  eslint-security:
    name: ESLint Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: natl-frontend/package-lock.json

      - name: Install dependencies
        working-directory: natl-frontend
        run: npm ci

      - name: Install ESLint security plugins
        working-directory: natl-frontend
        run: |
          npm install --save-dev \
            eslint \
            eslint-plugin-security \
            eslint-plugin-react-security \
            @microsoft/eslint-formatter-sarif

      - name: Run ESLint with security rules
        working-directory: natl-frontend
        run: |
          npx eslint \
            --ext .js,.jsx \
            --plugin security \
            --plugin react-security \
            --format @microsoft/eslint-formatter-sarif \
            --output-file ../eslint-results.sarif \
            src/ || true

      - name: Upload ESLint SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: eslint-results.sarif
          category: eslint-security

  npm-audit:
    name: npm Audit - Dependency Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: natl-frontend/package-lock.json

      - name: Run npm audit
        working-directory: natl-frontend
        run: |
          npm audit --json > npm-audit-results.json || true

      - name: Convert npm audit to SARIF
        if: always()
        working-directory: natl-frontend
        run: |
          cat > convert_npm_audit.js << 'EOF'
          const fs = require('fs');
          
          const auditData = JSON.parse(fs.readFileSync('npm-audit-results.json', 'utf8'));
          
          const sarif = {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "npm audit",
                  "informationUri": "https://docs.npmjs.com/cli/v8/commands/npm-audit",
                  "version": "1.0.0",
                  "rules": []
                }
              },
              "results": []
            }]
          };

          const vulnerabilities = auditData.vulnerabilities || {};
          const rulesMap = {};

          Object.entries(vulnerabilities).forEach(([packageName, vulnData]) => {
            const via = vulnData.via || [];
            
            via.forEach(issue => {
              if (typeof issue === 'object') {
                const ruleId = `${packageName}-${issue.cwe ? issue.cwe.join('-') : 'unknown'}`;
                
                if (!rulesMap[ruleId]) {
                  rulesMap[ruleId] = {
                    "id": ruleId,
                    "name": packageName,
                    "shortDescription": {
                      "text": issue.title || 'Security vulnerability'
                    },
                    "fullDescription": {
                      "text": issue.url || ''
                    },
                    "helpUri": issue.url || ''
                  };
                }

                const severityMap = {
                  'critical': 'error',
                  'high': 'error',
                  'moderate': 'warning',
                  'low': 'note',
                  'info': 'note'
                };

                sarif.runs[0].results.push({
                  "ruleId": ruleId,
                  "level": severityMap[vulnData.severity] || 'warning',
                  "message": {
                    "text": `${issue.title || 'Security vulnerability'} in ${packageName} - ${issue.url || ''}`
                  },
                  "locations": [{
                    "physicalLocation": {
                      "artifactLocation": {
                        "uri": "natl-frontend/package.json"
                      },
                      "region": {
                        "startLine": 1
                      }
                    }
                  }]
                });
              }
            });
          });

          sarif.runs[0].tool.driver.rules = Object.values(rulesMap);
          
          fs.writeFileSync('npm-audit-sarif.json', JSON.stringify(sarif, null, 2));
          EOF

          node convert_npm_audit.js

      - name: Upload npm audit SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: natl-frontend/npm-audit-sarif.json
          category: npm-audit

  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    container:
      image: returntocorp/semgrep
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep with React security rules
        run: |
          semgrep scan \
            --config "p/react" \
            --config "p/security-audit" \
            --config "p/javascript" \
            --config "p/owasp-top-ten" \
            --sarif \
            --output semgrep-results.sarif \
            natl-frontend/src/ || true

      - name: Upload Semgrep SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep

  retire-js:
    name: RetireJS - Vulnerable JavaScript Libraries
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install RetireJS
        run: npm install -g retire

      - name: Run RetireJS scan
        working-directory: natl-frontend
        run: |
          retire --outputformat json --outputpath retire-results.json || true

      - name: Convert RetireJS to SARIF
        if: always()
        working-directory: natl-frontend
        run: |
          cat > convert_retire.js << 'EOF'
          const fs = require('fs');
          
          let retireData = [];
          try {
            const rawData = JSON.parse(fs.readFileSync('retire-results.json', 'utf8'));
            // RetireJS can return either an array or an object with a 'data' property
            if (Array.isArray(rawData)) {
              retireData = rawData;
            } else if (rawData && rawData.data && Array.isArray(rawData.data)) {
              retireData = rawData.data;
            } else if (rawData && typeof rawData === 'object') {
              // If it's an object, wrap it in an array
              retireData = [rawData];
            }
          } catch (e) {
            console.log('No retire results found or error parsing:', e.message);
            retireData = [];
          }
          
          const sarif = {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "RetireJS",
                  "informationUri": "https://retirejs.github.io/retire.js/",
                  "version": "1.0.0",
                  "rules": []
                }
              },
              "results": []
            }]
          };

          const rulesMap = {};

          // Handle both array of files and individual file objects
          const files = Array.isArray(retireData) ? retireData : [retireData];
          
          files.forEach(file => {
            if (file && file.results) {
              file.results.forEach(result => {
                if (result.vulnerabilities) {
                  result.vulnerabilities.forEach(vuln => {
                    const ruleId = `${result.component}-${vuln.identifiers?.CVE?.[0] || 'unknown'}`;
                    
                    if (!rulesMap[ruleId]) {
                      rulesMap[ruleId] = {
                        "id": ruleId,
                        "name": result.component,
                        "shortDescription": {
                          "text": vuln.info?.[0] || 'Vulnerable JavaScript library detected'
                        },
                        "helpUri": vuln.info?.[0] || ''
                      };
                    }

                    const severityMap = {
                      'critical': 'error',
                      'high': 'error',
                      'medium': 'warning',
                      'low': 'note'
                    };

                    sarif.runs[0].results.push({
                      "ruleId": ruleId,
                      "level": severityMap[vuln.severity] || 'warning',
                      "message": {
                        "text": `Vulnerable version of ${result.component} detected: ${result.version}`
                      },
                      "locations": [{
                        "physicalLocation": {
                          "artifactLocation": {
                            "uri": file.file || "natl-frontend/"
                          },
                          "region": {
                            "startLine": 1
                          }
                        }
                      }]
                    });
                  });
                }
              });
            }
          });

          sarif.runs[0].tool.driver.rules = Object.values(rulesMap);
          
          fs.writeFileSync('retire-sarif.json', JSON.stringify(sarif, null, 2));
          EOF

          node convert_retire.js
          mv retire-sarif.json ../retire-sarif.json

      - name: Upload RetireJS SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: retire-sarif.json
          category: retirejs

  codeql:
    name: CodeQL Advanced Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: codeql-javascript

  summary:
    name: Security Analysis Summary
    runs-on: ubuntu-latest
    needs: [eslint-security, npm-audit, semgrep, retire-js, codeql]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# Frontend SAST Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Analysis Tools Run:" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint with security plugins" >> $GITHUB_STEP_SUMMARY
          echo "- npm audit (dependency vulnerabilities)" >> $GITHUB_STEP_SUMMARY
          echo "- Semgrep (React & OWASP security rules)" >> $GITHUB_STEP_SUMMARY
          echo "- RetireJS (vulnerable JavaScript libraries)" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL (advanced semantic analysis)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results Location" >> $GITHUB_STEP_SUMMARY
          echo "All security findings have been uploaded to the **Security** tab." >> $GITHUB_STEP_SUMMARY
          echo "Navigate to: Security → Code scanning → Alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review findings in the Security tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Prioritize critical and high severity issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Update dependencies with vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "4. Fix code-level security issues" >> $GITHUB_STEP_SUMMARY
